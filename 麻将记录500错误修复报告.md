# éº»å°†è®°å½• 500 é”™è¯¯ä¿®å¤æŠ¥å‘Š

## ğŸ”´ é—®é¢˜æè¿°

ç”¨æˆ·åœ¨ä½¿ç”¨éº»å°†è®°å½•åŠŸèƒ½æ—¶é‡åˆ° 500 é”™è¯¯ï¼š

```javascript
// å‰ç«¯é”™è¯¯
Mahjong.js:34 è·å–è®°å½•å¤±è´¥: AxiosError
:3000/api/mahjong:1 Failed to load resource: the server responded with a status of 500
Mahjong.js:93 ä¿å­˜å¤±è´¥: AxiosError
```

## ğŸ¯ é—®é¢˜æ ¹æº

**æ ¸å¿ƒé—®é¢˜ï¼š** `mahjong_records` è¡¨ä¸å­˜åœ¨

### è¯Šæ–­è¿‡ç¨‹

1. **æ£€æŸ¥åç«¯æ—¥å¿—** - æ²¡æœ‰çœ‹åˆ°å…·ä½“é”™è¯¯ä¿¡æ¯
2. **æ£€æŸ¥ Node è¿›ç¨‹** - 5ä¸ªNodeè¿›ç¨‹åœ¨è¿è¡Œ âœ…
3. **è¿è¡Œè¯Šæ–­è„šæœ¬** - å‘ç°è¡¨ä¸å­˜åœ¨ âŒ

```bash
node test-mahjong-data.js
# è¾“å‡º: âŒ mahjong_records è¡¨ä¸å­˜åœ¨ï¼
```

## âœ… è§£å†³æ–¹æ¡ˆ

### è¿è¡Œåˆå§‹åŒ–è„šæœ¬

```bash
npm run init-mahjong
```

**æ‰§è¡Œç»“æœï¼š**
```
âœ… éº»å°†è®°å½•è¡¨åˆ›å»ºæˆåŠŸï¼

è¡¨ç»“æ„:
  - mahjong_records: éº»å°†è®°å½•è¡¨
    * id: è®°å½•ID
    * user_id: ç”¨æˆ·ID
    * game_date: æ¸¸æˆæ—¥æœŸ
    * game_time: æ¸¸æˆæ—¶é—´
    * players: ç©å®¶åˆ—è¡¨ï¼ˆJSONï¼‰
    * scores: åˆ†æ•°åˆ—è¡¨ï¼ˆJSONï¼‰
    * win_amount: ç›ˆåˆ©é‡‘é¢
    * game_type: æ¸¸æˆç±»å‹
    * location: åœ°ç‚¹
    * notes: å¤‡æ³¨
```

## ğŸ“Š è¡¨ç»“æ„

### å®Œæ•´çš„æ•°æ®åº“å­—æ®µ

```sql
CREATE TABLE mahjong_records (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    game_date DATE NOT NULL,
    game_time TEXT,
    players TEXT NOT NULL,      -- JSONæ•°ç»„: ["æˆ‘"]
    scores TEXT NOT NULL,        -- JSONæ•°ç»„: [0]
    win_amount REAL NOT NULL,
    game_type TEXT,
    location TEXT,
    notes TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users (id) ON DELETE CASCADE
);
```

### å‰ç«¯ç®€åŒ–åçš„ä½¿ç”¨

è™½ç„¶å‰ç«¯åªæ˜¾ç¤º2ä¸ªå­—æ®µï¼Œä½†åç«¯ä»éœ€è¦å®Œæ•´å­—æ®µï¼š

```javascript
// å‰ç«¯æäº¤
{
  game_date: '2025-12-03',
  win_amount: 150
}

// å®é™…å‘é€åˆ°åç«¯
{
  game_date: '2025-12-03',
  game_time: '',
  players: ['æˆ‘'],        // é»˜è®¤å€¼
  scores: [0],            // é»˜è®¤å€¼
  win_amount: 150,
  game_type: '',
  location: '',
  notes: ''
}
```

## ğŸ” ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ä¸ªé—®é¢˜ï¼Ÿ

### å¯èƒ½çš„åŸå› 

1. **é¦–æ¬¡ä½¿ç”¨éº»å°†åŠŸèƒ½**
   - ç”¨æˆ·å¯èƒ½æ²¡æœ‰è¿è¡Œè¿‡ `npm run init-mahjong`
   - éº»å°†è¡¨ä»æœªè¢«åˆ›å»º

2. **æ•°æ®åº“è¢«é‡ç½®**
   - æ•°æ®åº“æ–‡ä»¶è¢«åˆ é™¤æˆ–é‡å»º
   - åªè¿è¡Œäº† `npm run init-db`ï¼ˆåŸºç¡€è¡¨ï¼‰
   - æ²¡æœ‰è¿è¡Œ `npm run init-mahjong`ï¼ˆéº»å°†è¡¨ï¼‰

3. **éƒ¨ç½²åˆ°æ–°ç¯å¢ƒ**
   - åœ¨æ–°ç”µè„‘ä¸Šéƒ¨ç½²é¡¹ç›®
   - åªå¤åˆ¶äº†ä»£ç ï¼Œæ²¡æœ‰åˆå§‹åŒ–æ•°æ®åº“

## ğŸš€ å®Œæ•´çš„åˆå§‹åŒ–æµç¨‹

### ç¬¬ä¸€æ¬¡ä½¿ç”¨ç³»ç»Ÿ

```bash
# 1. åˆå§‹åŒ–åŸºç¡€æ•°æ®åº“ï¼ˆç”¨æˆ·ã€åˆ†ç±»ã€è®°å½•è¡¨ï¼‰
npm run init-db

# 2. åˆå§‹åŒ–éº»å°†è¡¨
npm run init-mahjong

# 3. åˆå§‹åŒ–ç¤¼é‡‘è¡¨
npm run init-gifts

# 4. å¯åŠ¨åç«¯
npm start

# 5. å¯åŠ¨å‰ç«¯ï¼ˆå¦ä¸€ä¸ªç»ˆç«¯ï¼‰
cd frontend
npm start
```

### å·²æœ‰ç³»ç»Ÿæ·»åŠ æ–°æ¨¡å—

å¦‚æœç³»ç»Ÿå·²ç»åœ¨ä½¿ç”¨ï¼Œåªéœ€è¦æ·»åŠ æ–°æ¨¡å—ï¼š

```bash
# æ·»åŠ éº»å°†æ¨¡å—
npm run init-mahjong

# æ·»åŠ ç¤¼é‡‘æ¨¡å—
npm run init-gifts

# é‡å¯åç«¯
# Ctrl+C åœæ­¢ï¼Œç„¶å
npm start
```

## ğŸ“ æ¨¡å—ä¾èµ–å…³ç³»

### åŸºç¡€æ¨¡å—ï¼ˆå¿…é¡»ï¼‰
```bash
npm run init-db
```
åˆ›å»ºï¼š
- âœ… usersï¼ˆç”¨æˆ·è¡¨ï¼‰
- âœ… categoriesï¼ˆåˆ†ç±»è¡¨ï¼‰
- âœ… recordsï¼ˆè®°è´¦è®°å½•è¡¨ï¼‰

### æ‰©å±•æ¨¡å—ï¼ˆå¯é€‰ï¼‰
```bash
npm run init-mahjong  # éº»å°†è®°å½•è¡¨
npm run init-gifts    # ç¤¼é‡‘è®°å½•è¡¨
```

## âœ… éªŒè¯ä¿®å¤

### æµ‹è¯•æ­¥éª¤

1. **åˆ·æ–°å‰ç«¯é¡µé¢**
   ```
   Ctrl + Shift + R (å¼ºåˆ¶åˆ·æ–°)
   ```

2. **è®¿é—®éº»å°†è®°å½•**
   - ç‚¹å‡»å·¦ä¾§èœå• "ğŸ€„ éº»å°†è®°å½•"
   - åº”è¯¥æ­£å¸¸æ˜¾ç¤ºï¼ˆæš‚æ— è®°å½•ï¼‰
   - ä¸å†æœ‰ 500 é”™è¯¯

3. **æµ‹è¯•æ·»åŠ è®°å½•**
   - ç‚¹å‡» "+ æ·»åŠ è®°å½•"
   - å¡«å†™ï¼š
     - æ—¥æœŸï¼š2025-12-03
     - é‡‘é¢ï¼š+100
   - ç‚¹å‡»"ä¿å­˜"
   - åº”è¯¥æˆåŠŸæ·»åŠ 

4. **é¢„æœŸç»“æœ**
   - âœ… é¡µé¢æ­£å¸¸åŠ è½½
   - âœ… å¯ä»¥æ·»åŠ è®°å½•
   - âœ… è®°å½•æ˜¾ç¤ºåœ¨åˆ—è¡¨ä¸­
   - âœ… ä¸å†æœ‰é”™è¯¯

### æµè§ˆå™¨æ§åˆ¶å°éªŒè¯

æ‰“å¼€ F12 â†’ Consoleï¼Œåº”è¯¥çœ‹åˆ°ï¼š
```
ï¼ˆæ²¡æœ‰çº¢è‰²é”™è¯¯ä¿¡æ¯ï¼‰
```

Network æ ‡ç­¾åº”è¯¥æ˜¾ç¤ºï¼š
```
GET /api/mahjong â†’ 200 OK
POST /api/mahjong â†’ 201 Created
```

## ğŸ›¡ï¸ é˜²æ­¢ç±»ä¼¼é—®é¢˜

### 1. é¡¹ç›®æ–‡æ¡£ä¸­è¯´æ˜

åœ¨ README.md ä¸­æ˜ç¡®è¯´æ˜åˆå§‹åŒ–æ­¥éª¤ï¼š

```markdown
## æ•°æ®åº“åˆå§‹åŒ–

é¦–æ¬¡ä½¿ç”¨å¿…é¡»è¿è¡Œï¼š
1. npm run init-db       # åŸºç¡€è¡¨
2. npm run init-mahjong  # éº»å°†æ¨¡å—ï¼ˆå¯é€‰ï¼‰
3. npm run init-gifts    # ç¤¼é‡‘æ¨¡å—ï¼ˆå¯é€‰ï¼‰
```

### 2. æ·»åŠ æ£€æŸ¥è„šæœ¬

åˆ›å»ºä¸€ä¸ªæ£€æŸ¥è„šæœ¬ï¼Œå¯åŠ¨å‰éªŒè¯æ‰€æœ‰è¡¨ï¼š

```javascript
// scripts/checkTables.js
const db = require('../config/database').db;

const requiredTables = ['users', 'categories', 'records'];
const optionalTables = ['mahjong_records', 'gift_records'];

console.log('æ£€æŸ¥æ•°æ®åº“è¡¨...');

requiredTables.forEach(table => {
  const exists = db.prepare(
    "SELECT name FROM sqlite_master WHERE type='table' AND name=?"
  ).get(table);
  
  if (!exists) {
    console.error(`âŒ ç¼ºå°‘å¿…éœ€è¡¨: ${table}`);
    console.error(`è¯·è¿è¡Œ: npm run init-db`);
    process.exit(1);
  }
});

console.log('âœ… æ‰€æœ‰å¿…éœ€è¡¨éƒ½å­˜åœ¨');
```

### 3. åœ¨æœåŠ¡å™¨å¯åŠ¨æ—¶æ£€æŸ¥

åœ¨ `server.js` ä¸­æ·»åŠ è¡¨æ£€æŸ¥ï¼š

```javascript
// å¯åŠ¨å‰æ£€æŸ¥å¿…éœ€çš„è¡¨
function checkRequiredTables() {
  const requiredTables = ['users', 'categories', 'records'];
  const missingTables = [];
  
  requiredTables.forEach(table => {
    const exists = db.prepare(
      "SELECT name FROM sqlite_master WHERE type='table' AND name=?"
    ).get(table);
    
    if (!exists) {
      missingTables.push(table);
    }
  });
  
  if (missingTables.length > 0) {
    console.error('âŒ ç¼ºå°‘å¿…éœ€çš„æ•°æ®åº“è¡¨:', missingTables.join(', '));
    console.error('è¯·è¿è¡Œ: npm run init-db');
    process.exit(1);
  }
}

// åœ¨å¯åŠ¨æœåŠ¡å™¨å‰è°ƒç”¨
checkRequiredTables();
```

## ğŸ“‹ ç›¸å…³å‘½ä»¤

### åˆå§‹åŒ–å‘½ä»¤
```bash
npm run init-db       # åˆå§‹åŒ–åŸºç¡€æ•°æ®åº“
npm run init-mahjong  # åˆå§‹åŒ–éº»å°†è¡¨
npm run init-gifts    # åˆå§‹åŒ–ç¤¼é‡‘è¡¨
```

### æœåŠ¡å™¨å‘½ä»¤
```bash
npm start            # å¯åŠ¨ç”Ÿäº§æœåŠ¡å™¨
npm run dev          # å¯åŠ¨å¼€å‘æœåŠ¡å™¨ï¼ˆè‡ªåŠ¨é‡å¯ï¼‰
```

### æ•°æ®åº“ç®¡ç†
```bash
# æŸ¥çœ‹æ•°æ®åº“æ–‡ä»¶
ls database/accounting.db

# å¤‡ä»½æ•°æ®åº“
cp database/accounting.db database/backup_$(date +%Y%m%d).db
```

## ğŸ‰ æ€»ç»“

### é—®é¢˜
- âŒ `mahjong_records` è¡¨ä¸å­˜åœ¨
- âŒ å¯¼è‡´ 500 é”™è¯¯

### è§£å†³
- âœ… è¿è¡Œ `npm run init-mahjong`
- âœ… è¡¨åˆ›å»ºæˆåŠŸ
- âœ… åŠŸèƒ½æ¢å¤æ­£å¸¸

### é¢„é˜²
- âœ… æ–‡æ¡£ä¸­è¯´æ˜åˆå§‹åŒ–æ­¥éª¤
- âœ… å¯é€‰ï¼šæ·»åŠ å¯åŠ¨æ£€æŸ¥
- âœ… å¯é€‰ï¼šæ·»åŠ éªŒè¯è„šæœ¬

---

**é—®é¢˜å·²å®Œå…¨ä¿®å¤ï¼ç°åœ¨å¯ä»¥æ­£å¸¸ä½¿ç”¨éº»å°†è®°å½•åŠŸèƒ½äº†ï¼** ğŸŠ

## ğŸ”„ ä¸‹ä¸€æ­¥

åˆ·æ–°æµè§ˆå™¨é¡µé¢ï¼Œå¼€å§‹ä½¿ç”¨éº»å°†è®°å½•åŠŸèƒ½ï¼š
```
Ctrl + Shift + R (å¼ºåˆ¶åˆ·æ–°)
```

ä½“éªŒæç®€çš„éº»å°†è®°å½•ï¼šåªéœ€å¡«å†™æ—¥æœŸå’Œç›ˆäºé‡‘é¢ï¼âœ¨

