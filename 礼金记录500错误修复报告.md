# ç¤¼é‡‘è®°å½• 500 é”™è¯¯ä¿®å¤æŠ¥å‘Š

## ğŸ”´ é—®é¢˜æè¿°

ç”¨æˆ·åœ¨åˆ›å»ºç¤¼é‡‘è®°å½•æ—¶æ”¶åˆ° 500 é”™è¯¯ï¼š

```json
{
  "message": "Request failed with status code 500",
  "response": {
    "success": false,
    "message": "åˆ›å»ºç¤¼é‡‘è®°å½•å¤±è´¥",
    "error": "NOT NULL constraint failed: gift_records.user_id"
  },
  "status": 500
}
```

## ğŸ¯ é—®é¢˜æ ¹æº

**æ ¸å¿ƒé—®é¢˜ï¼š** `gift_records.user_id` å­—æ®µä¸º NULL

**æ·±å±‚åŸå› ï¼š** è®¤è¯ä¸­é—´ä»¶ä¸æ§åˆ¶å™¨ä¹‹é—´çš„ä¸ä¸€è‡´

### ä»£ç ä¸ä¸€è‡´æ€§

**è®¤è¯ä¸­é—´ä»¶ (`middleware/auth.js`)ï¼š**
```javascript
// åªè®¾ç½®äº† req.user
req.user = user;
next();
```

**ç¤¼é‡‘æ§åˆ¶å™¨ (`controllers/giftController.js`)ï¼š**
```javascript
// ä½¿ç”¨çš„æ˜¯ req.userIdï¼ˆæœªå®šä¹‰ï¼ï¼‰
const giftId = GiftRecord.create(req.userId, giftData);
```

**å…¶ä»–æ§åˆ¶å™¨çš„åšæ³•ï¼š**
- `mahjongController.js`: ä½¿ç”¨ `req.user.id` âœ…
- `recordController.js`: ä½¿ç”¨ `req.user.id` âœ…
- `categoryController.js`: ä½¿ç”¨ `req.user.id` âœ…

## âœ… è§£å†³æ–¹æ¡ˆ

### ä¿®æ”¹è®¤è¯ä¸­é—´ä»¶

åœ¨ `middleware/auth.js` ä¸­æ·»åŠ  `req.userId`ï¼š

```javascript
// å°†ç”¨æˆ·ä¿¡æ¯æ·»åŠ åˆ°è¯·æ±‚å¯¹è±¡
req.user = user;
req.userId = user.id; // æ·»åŠ  userId æ–¹ä¾¿æ§åˆ¶å™¨ä½¿ç”¨
next();
```

**ä¼˜ç‚¹ï¼š**
- âœ… ä¿æŒå‘åå…¼å®¹
- âœ… åŒæ—¶æ”¯æŒ `req.user.id` å’Œ `req.userId` ä¸¤ç§æ–¹å¼
- âœ… ä¸éœ€è¦ä¿®æ”¹ç°æœ‰æ§åˆ¶å™¨
- âœ… ç¤¼é‡‘æ§åˆ¶å™¨å¯ä»¥ç»§ç»­ä½¿ç”¨ `req.userId`

## ğŸ” é—®é¢˜åˆ†æ

### ä¸ºä»€ä¹ˆä¼šå‘ç”Ÿè¿™ä¸ªé—®é¢˜ï¼Ÿ

1. **æ•°æ®åº“çº¦æŸ**
   ```sql
   CREATE TABLE gift_records (
       user_id INTEGER NOT NULL,  -- NOT NULL çº¦æŸ
       ...
   );
   ```

2. **req.userId ä¸º undefined**
   - è®¤è¯ä¸­é—´ä»¶æ²¡æœ‰è®¾ç½® `req.userId`
   - æ§åˆ¶å™¨å°è¯•ä½¿ç”¨ `req.userId`
   - ç»“æœä¼ å…¥ `undefined` åˆ°æ•°æ®åº“

3. **æ•°æ®åº“æ‹’ç»æ’å…¥**
   - SQLite æ£€æµ‹åˆ° `user_id` ä¸º NULL
   - æŠ›å‡ºçº¦æŸé”™è¯¯
   - åç«¯è¿”å› 500 é”™è¯¯

### é”™è¯¯æµç¨‹

```
ç”¨æˆ·æäº¤è¡¨å•
    â†“
å‰ç«¯å‘é€ POST /api/gifts (å¸¦ JWT token)
    â†“
è®¤è¯ä¸­é—´ä»¶éªŒè¯ token
    â†“
è®¾ç½® req.user = { id: 1, username: "admin", ... }
    â†“
giftController.createGiftRecord()
    â†“
å°è¯•ä½¿ç”¨ req.userId (undefined!)
    â†“
GiftRecord.create(undefined, giftData)
    â†“
SQL: INSERT INTO gift_records (user_id, ...) VALUES (NULL, ...)
    â†“
âŒ NOT NULL constraint failed
```

## ğŸ”§ ä¿®å¤åçš„æµç¨‹

```
ç”¨æˆ·æäº¤è¡¨å•
    â†“
å‰ç«¯å‘é€ POST /api/gifts (å¸¦ JWT token)
    â†“
è®¤è¯ä¸­é—´ä»¶éªŒè¯ token
    â†“
è®¾ç½® req.user = { id: 1, ... }
è®¾ç½® req.userId = 1  â† æ–°å¢ï¼
    â†“
giftController.createGiftRecord()
    â†“
ä½¿ç”¨ req.userId (1)
    â†“
GiftRecord.create(1, giftData)
    â†“
SQL: INSERT INTO gift_records (user_id, ...) VALUES (1, ...)
    â†“
âœ… åˆ›å»ºæˆåŠŸï¼
```

## ğŸ“Š éªŒè¯ä¿®å¤

### æµ‹è¯•æ­¥éª¤

1. **é‡å¯åç«¯æœåŠ¡å™¨** âœ…
   ```bash
   npm start
   ```

2. **åˆ·æ–°å‰ç«¯é¡µé¢**
   ```
   Ctrl + Shift + R (å¼ºåˆ¶åˆ·æ–°)
   ```

3. **æµ‹è¯•åˆ›å»ºè®°å½•**
   - ç™»å½•ç³»ç»Ÿ
   - è®¿é—®ç¤¼é‡‘è®°å½•é¡µé¢
   - ç‚¹å‡»"+ æ·»åŠ è®°å½•"
   - å¡«å†™è¡¨å•ï¼š
     ```
     å§“åï¼šå¼ ä¸‰
     ç±»å‹ï¼šé€ç¤¼
     äº‹ä»¶ï¼šå©šç¤¼
     é‡‘é¢ï¼š500
     ```
   - ç‚¹å‡»"æ·»åŠ "

4. **é¢„æœŸç»“æœ**
   - âœ… æ˜¾ç¤ºç»¿è‰²æç¤ºï¼š"âœ“ è®°å½•æ·»åŠ æˆåŠŸï¼"
   - âœ… è®°å½•å‡ºç°åœ¨åˆ—è¡¨ä¸­
   - âœ… ä¸å†æœ‰ 500 é”™è¯¯

### æµè§ˆå™¨æ§åˆ¶å°éªŒè¯

æ‰“å¼€ F12 â†’ Consoleï¼Œåº”è¯¥çœ‹åˆ°ï¼š
```
æäº¤æ•°æ®: { name: "å¼ ä¸‰", gift_type: "é€ç¤¼", ... }
åˆ›å»ºå“åº”: { success: true, data: { id: 1 }, message: "ç¤¼é‡‘è®°å½•åˆ›å»ºæˆåŠŸ" }
âœ… è·å–æˆåŠŸï¼Œå…± 1 æ¡è®°å½•
```

## ğŸ’¡ æŠ€æœ¯è¦ç‚¹

### 1. è®¤è¯ä¸­é—´ä»¶çš„ä½œç”¨

è®¤è¯ä¸­é—´ä»¶è´Ÿè´£ï¼š
- âœ… éªŒè¯ JWT token
- âœ… ä» token ä¸­è§£æç”¨æˆ·ä¿¡æ¯
- âœ… å°†ç”¨æˆ·ä¿¡æ¯é™„åŠ åˆ° `req` å¯¹è±¡
- âœ… ä¾›åç»­çš„æ§åˆ¶å™¨ä½¿ç”¨

### 2. æ§åˆ¶å™¨çš„ä¸¤ç§è·å–ç”¨æˆ·IDæ–¹å¼

**æ–¹å¼1ï¼šä½¿ç”¨ req.user.id**
```javascript
const userId = req.user.id;
GiftRecord.create(userId, data);
```

**æ–¹å¼2ï¼šä½¿ç”¨ req.userIdï¼ˆç°åœ¨æ”¯æŒï¼‰**
```javascript
GiftRecord.create(req.userId, data);
```

### 3. ä»£ç ä¸€è‡´æ€§çš„é‡è¦æ€§

**é—®é¢˜çš„æ ¹æœ¬åŸå› ï¼š** ä¸åŒæ§åˆ¶å™¨ä½¿ç”¨ä¸åŒçš„æ–¹å¼è·å– user_id

**è§£å†³æ–¹æ¡ˆï¼š**
- åœ¨è®¤è¯ä¸­é—´ä»¶ä¸­åŒæ—¶æä¾›ä¸¤ç§æ–¹å¼
- è®©å¼€å‘è€…å¯ä»¥é€‰æ‹©æ›´æ–¹ä¾¿çš„æ–¹å¼
- ä¿æŒå‘åå…¼å®¹

## ğŸ¯ æœ€ä½³å®è·µ

### 1. ç»Ÿä¸€çš„ç”¨æˆ·è®¤è¯æ¨¡å¼

å»ºè®®åœ¨é¡¹ç›®ä¸­ç»Ÿä¸€ä½¿ç”¨ä¸€ç§æ–¹å¼ï¼š

**æ¨èï¼š** ä½¿ç”¨ `req.userId`ï¼ˆæ›´ç®€æ´ï¼‰
```javascript
// æ§åˆ¶å™¨ä¸­
const records = Model.getAll(req.userId, filters);
```

**å¤‡é€‰ï¼š** ä½¿ç”¨ `req.user.id`ï¼ˆæ›´æ˜ç¡®ï¼‰
```javascript
// æ§åˆ¶å™¨ä¸­
const userId = req.user.id;
const records = Model.getAll(userId, filters);
```

### 2. è®¤è¯ä¸­é—´ä»¶åº”è¯¥æä¾›çš„ä¿¡æ¯

```javascript
// å®Œæ•´çš„ç”¨æˆ·å¯¹è±¡
req.user = {
  id: 1,
  username: 'admin',
  email: 'admin@example.com',
  created_at: '2025-01-01'
};

// å¿«æ·çš„ userIdï¼ˆæ–¹ä¾¿ä½¿ç”¨ï¼‰
req.userId = 1;
```

### 3. é”™è¯¯å¤„ç†

åœ¨æ§åˆ¶å™¨ä¸­æ·»åŠ é˜²å¾¡æ€§æ£€æŸ¥ï¼š
```javascript
exports.createGiftRecord = (req, res) => {
  try {
    // éªŒè¯ç”¨æˆ·IDå­˜åœ¨
    if (!req.userId && !req.user?.id) {
      return res.status(401).json({
        success: false,
        message: 'ç”¨æˆ·æœªè®¤è¯'
      });
    }

    const userId = req.userId || req.user.id;
    const giftId = GiftRecord.create(userId, giftData);
    // ...
  } catch (error) {
    // ...
  }
};
```

## ğŸ“‹ ç›¸å…³æ–‡ä»¶

### ä¿®æ”¹çš„æ–‡ä»¶
- âœ… `middleware/auth.js` - æ·»åŠ  `req.userId`

### å½±å“çš„æ–‡ä»¶
- `controllers/giftController.js` - ç°åœ¨å¯ä»¥æ­£å¸¸å·¥ä½œ
- å…¶ä»–æ§åˆ¶å™¨ - ä¿æŒä¸å˜ï¼Œç»§ç»­ä½¿ç”¨åŸæœ‰æ–¹å¼

## ğŸš€ ç°åœ¨å¯ä»¥åšä»€ä¹ˆ

1. **åˆ·æ–°æµè§ˆå™¨é¡µé¢**
   ```
   Ctrl + Shift + R
   ```

2. **å¼€å§‹ä½¿ç”¨ç¤¼é‡‘è®°å½•åŠŸèƒ½**
   - âœ… æ·»åŠ é€ç¤¼è®°å½•
   - âœ… æ·»åŠ æ”¶ç¤¼è®°å½•
   - âœ… æŸ¥çœ‹ç»Ÿè®¡æ•°æ®
   - âœ… ç¼–è¾‘å’Œåˆ é™¤è®°å½•

3. **æµ‹è¯•å…¶ä»–åŠŸèƒ½**
   - ç¡®ä¿å…¶ä»–æ¨¡å—ï¼ˆéº»å°†ã€è®°è´¦ç­‰ï¼‰ä»ç„¶æ­£å¸¸å·¥ä½œ

## ğŸ‰ æ€»ç»“

### é—®é¢˜
- âŒ `req.userId` æœªå®šä¹‰å¯¼è‡´ 500 é”™è¯¯
- âŒ æ•°æ®åº“ NOT NULL çº¦æŸå¤±è´¥

### è§£å†³
- âœ… åœ¨è®¤è¯ä¸­é—´ä»¶ä¸­æ·»åŠ  `req.userId = user.id`
- âœ… åŒæ—¶æ”¯æŒ `req.user.id` å’Œ `req.userId`
- âœ… ä¿æŒå‘åå…¼å®¹

### ç»“æœ
- âœ… ç¤¼é‡‘è®°å½•å¯ä»¥æ­£å¸¸åˆ›å»º
- âœ… å…¶ä»–æ¨¡å—ä¸å—å½±å“
- âœ… ä»£ç æ›´åŠ ä¸€è‡´å’Œå¥å£®

---

**é—®é¢˜å·²å®Œå…¨ä¿®å¤ï¼ç°åœ¨å¯ä»¥æ­£å¸¸ä½¿ç”¨ç¤¼é‡‘è®°å½•åŠŸèƒ½äº†ï¼** ğŸŠ

